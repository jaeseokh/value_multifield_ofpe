---
title: "Project README: R Pipeline for OFPE Multi-Field Data Processing and Analysis"
format:
  html:
    toc: true
    theme: cosmo
    mainfont: "Inter"
editor: visual
---

## 1. Project Overview

This project provides a full-stack R pipeline for processing and analyzing On-Farm Precision Experiment (OFPE) data. The workflow is divided into two main phases:

1.  **Data Processing**: This phase ingests raw, individual OFPE trial data (yield, inputs, boundaries), fetches corresponding external geospatial and weather data (topography, soil, climate), and merges them into unified, analysis-ready datasets.

2.  **Data Analysis**: This phase uses the processed data to model yield-N response functions. It implements a leave-one-field-out cross-validation framework to evaluate the predictive performance of several machine learning models (XGBoost, Random Forest, Causal Forest) and a Gaussian Process model. The final goal is to assess the economic value and uncertainty of using multi-field data to predict field-specific optimal nitrogen rates.

This R pipeline serves as the canonical workflow for both data preparation and advanced modeling, and is structured to be reproducible and extensible.

## 2. Directory Structure

For this pipeline to run correctly, your project should follow this directory structure:

```         
your_project_root/
|
├── Code/
|   ├── 0_setup.R
|   ├── 1_main_data_processing.R
|   ├── 2_functions_processing.R
|   ├── 3_main_data_analysis.R
|   └── 4_functions_analysis.R
|
├── Data/
|   ├── Raw/
|   |   ├── exp_tb_data/      # Folder with individual trial tables (*_tb.rds)
|   |   ├── exp_bdry_data/    # Folder with individual trial boundaries (*_bdry.rds)
|   |   └── ... (other raw data files)
|   |
|   └── Processed/
|       └── Analysis_ready/   # Output directory for processed files
|
└── your_project.Rproj        # Your RStudio Project file
```

## 3. How to Run the Analysis

1.  **Open your RStudio Project.** This ensures that the `here()` package works correctly to find your files.

2.  **Run the Setup Script:** Open and execute `Code/0_setup.R` once to ensure all necessary packages are installed.

3.  **Run the Data Processing Pipeline:** Open and execute `Code/1_main_data_processing.R`. This will generate the `dat_binded.rds` and `info_binded.rds` files needed for analysis.

4.  **Run the Data Analysis Pipeline:** Open and execute `Code/3_main_data_analysis.R`. This script will load the processed data, run the cross-validation for all models, and save the results.

## 4. Script Descriptions

-   **`Code/0_setup.R`**: Checks for and installs all required R packages for both processing and analysis.

-   **`Code/1_main_data_processing.R`**: The master script for the data processing phase.

-   **`Code/2_functions_processing.R`**: Contains all custom functions for fetching and processing raw and external data.

-   **`Code/3_main_data_analysis.R`**: The master script for the analysis phase, including the cross-validation loops for all models.

-   **`Code/4_functions_analysis.R`**: Contains helper functions for the analysis, such as EONR calculation.

## 5. Key Output Files

The pipeline generates several key output files in `Data/Processed/Analysis_ready/`:

-   **`dat_binded.rds`**: The main block-level dataset with all features.

-   **`info_binded.rds`**: Field-level metadata.

-   **`xgb_model_list.rds`, `rf_model_list.rds`, etc.**: Saved model objects from the analysis.

-   **`result_tab_list.rds`**: A list containing the EONR and profit calculations for each field-year.